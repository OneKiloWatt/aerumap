# あいまっぷ 要件定義書（Ver. 0.2c）

## 1. 概要

| 項目           | 内容 |
|----------------|------|
| **プロダクト名** | あいまっぷ（aimap） |
| **目的**       | 「今どこ？」のやり取りを省き、友人・恋人・家族との待ち合わせを円滑にするリアルタイム位置共有Webアプリ |
| **対象ユーザー** | カジュアルな待ち合わせをする一般ユーザー（Z世代〜30代前半中心） |
| **提供形態**   | インストール不要のWebアプリ（スマホブラウザ対応） |

---

## 2. 使用技術スタック

| 区分             | 技術                            | 用途                                   |
|------------------|----------------------------------|----------------------------------------|
| フロントエンド   | React + React-Leaflet           | UI、地図描画（OpenStreetMap）         |
| ホスティング     | GitHub Pages                    | React SPAのホスティング               |
| バックエンド     | Firebase（Auth / Firestore / Functions） | 認証・DB・セキュリティ制御            |
| 認証             | 匿名認証（Firebase Auth）       | URL参加＋匿名ユーザー識別             |
| 通信方式         | FirestoreのonSnapshot()         | 位置情報のリアルタイム監視            |

---

## 3. 機能一覧（MVPスコープ）

| カテゴリ     | 機能名               | 概要 |
|--------------|----------------------|------|
| ルーム        | ルーム作成            | 一意なIDでルームを作成し、参加リンクを生成 |
| 招待          | ルーム参加URL発行     | 他人をURLで招待（LINE等で送信） |
| 誘導          | ニックネーム入力       | 初回参加時に表示名を設定。実名使用を避けるよう案内 |
| 誘導          | 最終確認モーダル       | 位置共有や信用性についての注意喚起 |
| 位置共有      | 自分の位置を送信      | Firestoreへ現在地をアップロード（変化時＋最大30秒ごと） |
| 位置共有      | 他者の位置を表示      | ルーム内参加者の位置をマップ上にリアルタイム表示 |
| UI            | 地図描画             | React-Leafletで現在地を中心にマーカー表示（自動追従なし） |
| セキュリティ  | アクセス制御          | 認証済ユーザーのみFirestore書き込み可（匿名） |
| セキュリティ  | 退出処理              | 自分の位置＆メンバー情報を削除してルームを退出 |
| バックエンド  | ルーム自動削除        | 作成から3時間経過後、削除対象となり、3時間おきに定期削除処理が実行される |

---

## 4. 非機能要件

| 項目             | 内容 |
|------------------|------|
| 対応端末         | スマホ中心（iOS/Androidのブラウザ）＋PC |
| 更新頻度         | **位置情報の更新は、位置が変化した場合または最大30秒ごとに送信** |
| UI要件           | 地図は自由にパン／ズーム可、現在地自動追従なし |
| セキュリティ     | HTTPS必須、Firestoreルールによる厳密な認可制御 |
| 利用人数想定     | 1ルームあたり最大10人程度 |
| タイル提供元     | OpenStreetMap（Leaflet標準タイル） |
| 地理的制限       | 日本国内IPアドレスのみアクセス許可（Cloud Functionsによる制御） |
| 誘導             | 実名禁止・信用できるURLかどうかの最終確認を促すUX設計 |
| データ保持       | 退出操作により即時削除、退出しない場合も3時間経過後に削除対象となり、最大6時間以内に削除される |
| ログ管理         | APIアクセスログ（IP、UID等）を記録し最大30日間保持（監査協力可能） |
| 年齢制限         | 13歳未満のユーザーは利用不可（保護者の同意があっても不可） |
| 定期削除         | GitHub Actionsにより3時間おきにルーム削除処理を実行 |
| 利用規約/セキュリティ | 利用規約・セキュリティ仕様は別途 `TERMS.md`・`SECURITY.md` にて明示 |

---

## 5. ページ一覧

| パス | ページ名 | 主な役割 |
|------|----------|----------|
| `/` | トップページ | サービス紹介 |
| `/room/:roomId` | ルーム参加ページ | ルームに参加し、ニックネーム登録・位置共有を行う |
| `/no-location` | 位置情報取得失敗ページ | 位置情報取得に失敗した場合の対処案内ページ |
| `/goodbye` | 退出完了ページ | ユーザーが明示的にルーム退出した後の案内ページ |
| `/terms` | 利用規約ページ | 利用規約およびセキュリティポリシーを表示 |
| `/404`（自動） | エラーページ | 不正URLや存在しないルームアクセス時のエラー表示 |

---

## 6. バックエンドAPIエンドポイント一覧

| メソッド | パス | 説明 | 制限 |
|----------|------|------|------|
| `POST` | `/api/createRoom` | 新しいルームを作成する | 同一IPから30分に5回まで |
| `POST` | `/api/joinRoom` | 招待URL経由で参加するユーザーをメンバー登録 | 同一IPからの失敗は5回で一時ブロック |
| `DELETE` | `/api/exitRoom` | 現在のルームから退出し、自分の情報を削除 | UID必須・認証済みのみ |
| `POST` | `/api/cleanupRooms` | 有効期限切れルームを一括削除（内部用） | GitHub Actionsから3時間おきに実行 |

---

## 7. サーバー構成図

* サーバー構成図：

![サーバー構成図](server.drawio.png)

