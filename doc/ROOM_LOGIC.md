# ROOM\_LOGIC.md

## あいまっぷ：ルーム参加〜退出までのロジック仕様書

このドキュメントは、ユーザーがルームに参加してから退出・削除されるまでの一連のロジックや状態遷移、タイムアウトや定期削除の流れを定義する。

---

## 1. ルーム作成フロー

### ✅ 処理概要

* ボタン押下でランダムな `roomId` を生成
* `rooms/{roomId}` ドキュメントを作成（`createdAt` 記録）
* `expiresAt` を `createdAt + 3時間` に設定
* 作成者は自動で匿名認証され、ルームに参加登録される

---

## 2. ルーム参加フロー（招待URL踏んだとき）

### ✅ クライアント処理（`validateAndJoinRoom`）

1. `roomId` の存在チェック → 無ければエラー表示
2. 認証されていなければ匿名ログイン（UID発行）
3. `rooms/{roomId}/members/{uid}` の存在チェック
4. 無ければ `joinedAt`, `nickname`, `message` を含めて新規作成

※ 初参加時は「ニックネーム入力 → 注意事項表示 → 同意」フローあり

---

## 3. 定期位置更新・購読

### ✅ 更新（クライアントから）

* 関数例：`writeLocation(roomId, uid, {lat, lng})`
* 位置変化時または最大30秒間隔で更新
* `rooms/{roomId}/locations/{uid}` に書き込み

### ✅ 購読（クライアントで）

* 関数例：`subscribeLocations(roomId, callback)`
* Firestore `onSnapshot()` を使用し、他人の位置をリアルタイム表示

---

## 4. 退出フロー（任意）

### ✅ クライアント操作で退出

* `rooms/{roomId}/members/{uid}` を削除
* `rooms/{roomId}/locations/{uid}` を削除
* Firestoreルールにより以後アクセス不可

※ 退出操作を行わない限り、データはルーム期限まで保持される

---

## 5. ルームの有効期限と自動削除

### ✅ 有効期限

* 各ルームに `expiresAt`（作成から3時間後）を設定
* クライアントは `expiresAt < now()` をもとに期限切れ判定・UI制御
* 期限切れルームには参加・更新できないよう制御

### ✅ 定期削除処理

* GitHub Actions で **3時間おきに定期実行**
* Cloud Functions or Admin SDK 経由で `expiresAt < now()` のルームを削除
* 削除対象：`rooms/{roomId}` 配下の全データ

---

## 6. ルーム制限

### ✅ 制限内容

* 同一IPアドレスからのルーム作成回数：30分間に5回まで
* 招待URL踏み処理も同様にアクセス回数を記録・制限
* 閾値を超えた場合、Cloud Functions が参加拒否レスポンス

---

## 7. セキュリティ確認・エラー防止

### ✅ クライアント上での処理

* `roomId` の存在チェック → 存在しない場合エラー
* `members/{uid}` に登録されていない場合、UIで注意
* 信頼できる招待者からのURLであることを明示
* 位置情報共有の意図とリスクを説明し、明示的な同意を得る

---

## 8. 備考

* Firestore の read/write は Firestore Rules によってメンバー限定に制限
* クライアント処理によって参加チェック・登録・拒否を柔軟に制御
* 複数ルームに同時参加可能で、それぞれ異なるニックネーム・状態を保持
* `nickname`, `message` はルーム単位で設定・変更可能

---

