# ルーム参加ページ使用設計書

## Ⅰ. 概要

| 項目     | 内容                                     |
| ------ | -------------------------------------- |
| ページ名   | ルーム参加ページ                               |
| パス     | `/room/:roomId`                        |
| 主な役割   | 招待URLからルームに参加し、ニックネーム登録や住所共有を開始する      |
| 対象ユーザー | 招待リンクから転送されてきた新規ユーザー                   |
| 前提     | Firebase の匿名認証が完了していること、または転送と同時に認証を行う |

---

## Ⅱ. 画面ステージ構成

### 【STEP1】参加前フェーズ（2段階確認付き）

#### ✅ 確認STEP①：アプリ説明＋ニックネーム入力

- 画面上部に「あいまっぷは、友達や家族との待ち合わせを円滑にするリアルタイム位置共有アプリです」と明記
- 以下の文言も含めて明示：
  > **このルームに参加すると、あなたの現在地がリアルタイムで他の参加者と共有されます。**
- `nickname`（必須）の入力フォームを表示
  - 例：「電車で向かってます🚃」「ちょっと遅れるかも🙏」など軽い会話を想定
- 「次へ」ボタンを押すと、入力値を一時保存しSTEP②へ進む

#### ✅ 確認STEP②：注意喚起モーダル（セキュリティ確認）

- タイトル：「⚠️ このリンク、ほんとに信用できる？」
- 内容：
  > **このリンクが信用できる人物から送られたものでなければ、絶対に参加しないでください。**
  >
  > 位置情報がリアルタイムで共有されることを理解し、信頼できる相手であることを確認してください。
- チェックボックス「上記に同意する」にチェックしないと参加ボタンが活性化されない
- 「参加する」ボタンを押すと Firestore `members` に `nickname`, `joinedAt` を保存し、地図画面へ遷移

| 要素          | 内容                                               |
| ----------- | ------------------------------------------------ |
| ヘッダー        | アプリ名、戻るボタン                                       |
| アプリ説明       | 「今どこ」を解消して待ち合わせをスムーズにするアプリ。住所共有があります。            |
| ニックネーム入力    | 必須。実名禁止の説明付き                                     |
| **確認STEP①** | **上記内容を確認した上で「次へ」ボタンを押す** → 入力データを一時保存し、STEP②へ遷移 |
| **確認STEP②** | **注意喚起モーダル（このリンク、ほんとに信用できる？）**                   |

- 信用できる人からのリンクでなければ絶対に参加しないで！と強調
- 内容確認チェック → 同意必須 | | 参加ボタン | 「参加する」を押すと Firestore `members` へ登録し、参加後フェーズへ遷移 |

---

### 【STEP2】参加後フェーズ

#### ✅ 位置情報の送信・地図の更新頻度

##### 🔁 自端末の位置送信仕様

| 条件       | 内容                                |
| -------- | --------------------------------- |
| 最短更新間隔   | 5秒ごと（それ未満の送信は無視）                  |
| 最大更新間隔   | 30秒以内に1回は必ず送信（静止時でも）              |
| 位置変化トリガー | 前回送信地点から5m以上動いた場合に即送信（ただし5秒未満は抑制） |

- 送信対象：Firestore `locations` に `uid`, `lat`, `lng`, `updatedAt` を保存
- バッテリー・通信量配慮のため、画面非表示時（バックグラウンド）は送信停止

##### 🗺️ 地図表示の更新仕様

- Firestore `locations` を `onSnapshot` でリアルタイム購読
- 他ユーザーの位置変化があれば即座に反映
- 連続更新が多い場合に備え、内部で5秒に1回までの `throttle` 処理を行うことで描画負荷を軽減

#### ✅ トースト通知（Toast UI）

##### 表示ルール

トーストは「表示目的」によって表示位置と表示時間を区別する：

| 分類         | 表示位置 | 表示時間       | 内容例                       |
| ---------- | ---- | ---------- | ------------------------- |
| 🟥 エラー系    | 画面上部 | 常駐（手動で閉じる） | 位置情報取得失敗・参加失敗など           |
| 🟩 通知系（情報） | 画面下部 | 自動で3〜5秒表示  | 他ユーザーのメッセージ更新・退出完了・参加完了など |

##### 実装補足：

- エラー系は赤系背景＋⚠️アイコンなどで即座にユーザーの注意を引く
- 通知系はフェードイン・アウトで控えめに表示し、画面操作を妨げないようにする
- モバイル画面ではタブバーや固定ボタンに被らないよう、下部トーストの表示位置に `padding-bottom` を考慮

##### トースト種類一覧

###### 🟥 エラー系（上部表示・常駐）

| イベント      | 表示メッセージ例                              |
| --------- | ------------------------------------- |
| 位置情報取得に失敗 | 位置情報が取得できませんでした。設定方法はこちら：/no-location |
| 参加に失敗     | ルームへの参加に失敗しました。もう一度お試しください。           |
| 退出に失敗     | ルームからの退出に失敗しました。通信状況をご確認ください。         |
| 権限エラー     | アクセス権限がありません。このルームには参加できません。          |
| 有効期限切れ    | このルームの有効期限は終了しています。新しい招待を確認してください。    |
| 通信エラー全般   | 通信に失敗しました。ネットワーク環境をご確認ください。           |

###### 🟩 通知系（下部表示・3〜5秒）

| イベント         | 表示メッセージ例               |
| ------------ | ---------------------- |
| 他の人がメッセージ更新  | ○○さんがメッセージを更新しました：「〇〇」 |
| 自分のメッセージ更新完了 | メッセージを更新しました。          |
| 自分が退出完了      | ルームから退出しました。おつかれさま！    |
| 他の人が退出       | ○○さんがルームから退出しました。      |
| 他の人が参加       | ○○さんがルームに参加しました。       |
| 初回参加完了       | ルームに参加しました！地図をチェックしてね  |

トーストは「表示目的」によって表示位置と表示時間を区別する：

| 分類         | 表示位置 | 表示時間       | 内容例                  |
| ---------- | ---- | ---------- | -------------------- |
| 🟥 エラー系    | 画面上部 | 常駐（手動で閉じる） | 位置情報取得失敗・参加失敗など      |
| 🟩 通知系（情報） | 画面下部 | 自動で3〜5秒表示  | 他ユーザーのメッセージ更新・退出完了など |

##### 実装補足：

- エラー系は赤系背景＋⚠️アイコンなどで即座にユーザーの注意を引く
- 通知系はフェードイン・アウトで控えめに表示し、画面操作を妨げないようにする
- モバイル画面ではタブバーや固定ボタンに被らないよう、下部トーストの表示位置に `padding-bottom` を考慮

##### トースト内容例：

| 種類        | 表示メッセージ例                                                       |
| --------- | -------------------------------------------------------------- |
| 位置情報取得失敗  | **位置情報が取得できませんでした。設定方法はこちら：** [位置情報の取得を有効にするには？](/no-location) |
| メッセージ更新通知 | **○○さんがメッセージを更新しました：「〇〇」**                                     |

#### ✅ 位置情報取得失敗時の挙動

- ユーザーの端末で位置情報が取得できなかった場合（ブラウザ設定など）には、即座にトースト通知を表示：
  > **位置情報が取得できませんでした。設定方法はこちら：** [位置情報の取得を有効にするには？](/no-location)
- トーストは5〜7秒程度表示し、ユーザーが確認・再試行できる導線を提供

#### ✅ メッセージ入力・更新機能

#### ✅ マーカータップ時の吹き出し表示内容

| タップ対象      | 表示内容                                                                       |
| ---------- | -------------------------------------------------------------------------- |
| **他人マーカー** | - ニックネーム- メッセージ（任意）- 最終更新時刻（例：14:32更新）- 自分からの距離（例：350m）                    |
| **自分マーカー** | - ニックネーム- メッセージ（任意）- 最終更新時刻- 自分からの距離- ✏️ メッセージ編集ボタン（吹き出し下部に表示）※退出ボタンは表示しない |

#### ✅ 地図右上のオプション（≡ メニュー）

- 画面右上にオプションボタンを設置（≡ or 歯車）
- 押すと以下のようなメニューを表示：

```
┌──────────────┐
│ 🚪 ルームから退出する │
└──────────────┘
```

- 「退出する」を選ぶと Firestore `members`, `locations` を削除し、トースト表示後に `/goodbye` へ遷移

- 自分のマーカーをタップすると「ひとことメッセージを入力」モーダルを表示できる

- 入力されたメッセージは Firestore `rooms/{roomId}/members/{uid}` の `message` に保存

- マーカーの吹き出しに `nickname + message` を表示

- 他のユーザーがメッセージを更新した場合は、リアルタイムで吹き出しに反映し、 **「○○さんがメッセージを更新しました」などのトースト通知** を画面下部に表示（5秒程度）

---

| 要素     | 内容                                      |
| ------ | --------------------------------------- |
| 地図表示   | React-Leaflet。自分の現在地、ルーム内の他ユーザーをマーカーで表示 |
| 自分マーカー | UID に基づく。ニックネーム付記                       |
| 他人マーカー | Firestore `locations` を onSnapshot で購読  |
| 退出ボタン | Firestore `members`, `locations` を削除し、トースト通知を表示後に `/goodbye` ページへリダイレクト |

---

## Ⅲ. デザインボイス

- スマホファースト前提
- 一列スクロール型、大きめのボタン/入力枠
- 全画面モーダル or ボトムスライドモーダル
- 地図表示は9:16ビューの大きめ領域を確保

---

## Ⅳ. 変更ログ

- 設計方針をスマホユーザー優先に切り替え
- 信用認識に関する警告を強化
- **2段階確認の導入**：「①入力 → ②信用確認」モーダルステップを追加

---

より完成度の高い使用設計として、このフローに基づき実装を進める。


