rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== ãƒ«ãƒ¼ãƒ æƒ…å ±ï¼ˆãƒ¡ã‚¿æƒ…å ±ï¼‰ =====
    match /rooms/{roomId} {
      // èª­ã¿å–ã‚Šï¼šãã®ãƒ«ãƒ¼ãƒ ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿
      allow read: if exists(/databases/$(database)/documents/rooms/$(roomId)/members/$(request.auth.uid));
      
      // æ›¸ãè¾¼ã¿ï¼šèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼ˆãƒ«ãƒ¼ãƒ ä½œæˆç”¨ï¼‰
      allow create: if request.auth != null;
      
      // æ›´æ–°ãƒ»å‰Šé™¤ï¼šç¦æ­¢ï¼ˆCloud Functions/GitHub ActionsçµŒç”±ã®ã¿ï¼‰
      allow update, delete: if false;
    }

    // ===== ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²ãƒ»ç®¡ç† =====
    match /rooms/{roomId}/members/{uid} {
      // ğŸ”§ ä¿®æ­£ï¼šèª­ã¿å–ã‚Š - æœ¬äºº ã¾ãŸã¯ åŒã˜ãƒ«ãƒ¼ãƒ ã®ãƒ¡ãƒ³ãƒãƒ¼
      allow read: if request.auth.uid == uid 
                  || exists(/databases/$(database)/documents/rooms/$(roomId)/members/$(request.auth.uid));
      
      // æ›¸ãè¾¼ã¿ï¼šæœ¬äººã®ã¿ï¼ˆå‚åŠ ç™»éŒ²ç”¨ï¼‰
      allow create, update: if request.auth.uid == uid;
      
      // å‰Šé™¤ï¼šæœ¬äººã®ã¿ï¼ˆé€€å‡ºæ©Ÿèƒ½ç”¨ï¼‰
      allow delete: if request.auth.uid == uid;
    }

    // ===== ä½ç½®æƒ…å ±ã®å…±æœ‰ =====
    match /rooms/{roomId}/locations/{uid} {
      // èª­ã¿å–ã‚Šï¼šãã®ãƒ«ãƒ¼ãƒ ã®ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡
      allow read: if exists(/databases/$(database)/documents/rooms/$(roomId)/members/$(request.auth.uid));
      
      // æ›¸ãè¾¼ã¿ï¼šæœ¬äººã®ã¿ï¼ˆãªã‚Šã™ã¾ã—é˜²æ­¢ï¼‰
      allow create, update: if request.auth.uid == uid;
      
      // å‰Šé™¤ï¼šæœ¬äººã®ã¿ï¼ˆé€€å‡ºæ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç”¨ï¼‰
      allow delete: if request.auth.uid == uid;
    }

    // ===== ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç®¡ç†ï¼ˆå†…éƒ¨å‡¦ç†ç”¨ï¼‰ =====
    match /rateLimits/{document} {
      // Cloud Functions ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹
      allow read, write: if request.auth != null;
    }

    // ===== ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ï¼ˆå†…éƒ¨å‡¦ç†ç”¨ï¼‰ =====
    match /accessLogs/{document} {
      // Cloud Functions ã‹ã‚‰ã®æ›¸ãè¾¼ã¿ã®ã¿
      allow write: if request.auth != null;
      // èª­ã¿å–ã‚Šã¯ç¦æ­¢ï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ï¼‰
      allow read: if false;
    }

    // ===== ãã®ä»–ã™ã¹ã¦æ‹’å¦ =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}